2. Checking Nginx configuration...
   ✓ Nginx configuration is valid
3. Checking Nginx site configuration...
   ✓ Nginx site configuration exists
4. Checking website connectivity...
   ✗ Website is not responding properly
   HTTP response:
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   166  100   166    0     0   1098      0 --:--:-- --:--:-- --:--:--  1106
HTTP/1.1 502 Bad Gateway
Server: nginx/1.18.0 (Ubuntu)
Date: Wed, 07 May 2025 17:23:46 GMT
Content-Type: text/html
Content-Length: 166
Connection: keep-alive

<html>
<head><title>502 Bad Gateway</title></head>
<body>
5. Checking direct API access...
   ✗ API server is not accessible
   Trying secondary check...
   ✗ Port 5000 is not open
6. Checking for recent application logs...
   Recent logs (last 20 lines):
total 3060
drwxrwxrwx  2 www-data www-data     136 May  8 01:19 .
drwxr-xr-x 13 root     root        4096 May  6 21:57 ..
-rw-r--r--  1 www-data www-data  634262 May  8 00:52 app.log
-rw-r--r--  1 www-data www-data  119699 May  7 18:00 data-import.log
-rw-r--r--  1 www-data www-data    4494 May  8 01:23 direct-run-20250508.log
-rw-r--r--  1 www-data www-data  164522 May  8 00:52 error.log
-rw-r--r--  1 www-data www-data 1714850 May  8 01:19 filmflex-20250508.log
-rw-r--r--  1 www-data www-data  469740 May  8 00:40 out.log
   === Most recent log: /var/log/filmflex/direct-run-20250508.log ===
NPM version: 10.8.2
Checking for required dependencies...
Starting server...
file:///var/www/filmflex/filmflex-server.js:11
const express = require('express');
                ^

ReferenceError: require is not defined in ES module scope, you can use import instead
This file is being treated as an ES module because it has a '.js' file extension and '/var/www/filmflex/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
    at file:///var/www/filmflex/filmflex-server.js:11:17
    at ModuleJob.run (node:internal/modules/esm/module_job:263:25)
    at async ModuleLoader.import (node:internal/modules/esm/loader:540:24)
    at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)

Node.js v20.19.1
Starting FilmFlex direct run at Thu May  8 01:23:38 CST 2025
Working directory: /var/www/filmflex
Server file: /var/www/filmflex/filmflex-server.js
Log file: /var/log/filmflex/direct-run-20250508.log
Node version: v20.19.1
7. Checking PM2 logs for FilmFlex...
[TAILING] Tailing last 20 lines for [filmflex] process (change the value with --lines option)
/root/.pm2/logs/filmflex-out.log last 20 lines:
0|filmflex |     └── pg@8.15.6 deduped
0|filmflex | 
0|filmflex | Starting server...
0|filmflex | file:///var/www/filmflex/filmflex-server.js:11
0|filmflex | const express = require('express');
0|filmflex |                 ^
0|filmflex | 
0|filmflex | ReferenceError: require is not defined in ES module scope, you can use import instead
0|filmflex | This file is being treated as an ES module because it has a '.js' file extension and '/var/www/filmflex/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
0|filmflex |     at file:///var/www/filmflex/filmflex-server.js:11:17
0|filmflex |     at ModuleJob.run (node:internal/modules/esm/module_job:263:25)
0|filmflex |     at async ModuleLoader.import (node:internal/modules/esm/loader:540:24)
0|filmflex |     at async asyncRunEntryPointWithESMLoader (node:internal/modules/run_main:117:5)
0|filmflex | 
0|filmflex | Node.js v20.19.1
0|filmflex | Starting FilmFlex direct run at Thu May  8 01:23:38 CST 2025
0|filmflex | Working directory: /var/www/filmflex
0|filmflex | Server file: /var/www/filmflex/filmflex-server.js
0|filmflex | Log file: /var/log/filmflex/direct-run-20250508.log
0|filmflex | Node version: v20.19.1

/root/.pm2/logs/filmflex-error.log last 20 lines:
0|filmflex | ReferenceError: require is not defined in ES module scope, you can use import instead
0|filmflex | This file is being treated as an ES module because it has a '.js' file extension and '/var/www/filmflex/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
0|filmflex |     at file:///var/www/filmflex/filmflex-server.js:11:17
0|filmflex |     at ModuleJob.run (node:internal/modules/esm/module_job:263:25)
0|filmflex |     at async ModuleLoader.import (node:internal/modules/esm/loader:540:24)
0|filmflex | ReferenceError: require is not defined in ES module scope, you can use import instead
0|filmflex | This file is being treated as an ES module because it has a '.js' file extension and '/var/www/filmflex/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
0|filmflex |     at file:///var/www/filmflex/simple-server.js:3:17
0|filmflex |     at ModuleJob.run (node:internal/modules/esm/module_job:263:25)
0|filmflex |     at async ModuleLoader.import (node:internal/modules/esm/loader:540:24)
0|filmflex | ReferenceError: require is not defined in ES module scope, you can use import instead
0|filmflex | This file is being treated as an ES module because it has a '.js' file extension and '/var/www/filmflex/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
0|filmflex |     at file:///var/www/filmflex/filmflex-server.js:11:17
0|filmflex |     at ModuleJob.run (node:internal/modules/esm/module_job:263:25)
0|filmflex |     at async ModuleLoader.import (node:internal/modules/esm/loader:540:24)
0|filmflex | ReferenceError: require is not defined in ES module scope, you can use import instead
0|filmflex | This file is being treated as an ES module because it has a '.js' file extension and '/var/www/filmflex/package.json' contains "type": "module". To treat it as a CommonJS script, rename it to use the '.cjs' file extension.
0|filmflex |     at file:///var/www/filmflex/simple-server.js:3:17
0|filmflex |     at ModuleJob.run (node:internal/modules/esm/module_job:263:25)
0|filmflex |     at async ModuleLoader.import (node:internal/modules/esm/loader:540:24)

8. Checking server files...
   ✓ FilmFlex server file exists
9. Checking Nginx upstream...
/etc/nginx/sites-available/filmflex:6:        proxy_pass http://localhost:5000;
/etc/nginx/sites-available/filmflex:60:#         proxy_pass http://localhost:5000;
/etc/nginx/sites-available/phimgg.com:5:        proxy_pass http://localhost:5000;
   ✓ Nginx upstream configuration found
10. Checking Node.js and npm versions...
v20.19.1
10.8.2
11. Checking for required npm packages...
rest-express@1.0.0 /var/www/filmflex
└── express@4.21.2

rest-express@1.0.0 /var/www/filmflex
├─┬ connect-pg-simple@10.0.0
│ └── pg@8.15.6 deduped
├─┬ drizzle-orm@0.39.1
│ └── pg@8.15.6 deduped
└─┬ pg@8.15.6
  └─┬ pg-pool@3.9.6
    └── pg@8.15.6 deduped

12. Checking file permissions...
   === Checking server files ===
-rwxr-xr-x 1 root root 6080 May  8 01:23 /var/www/filmflex/filmflex-server.js
-rwxr-xr-x 1 root root 1746 May  8 01:23 /var/www/filmflex/direct-run.sh
13. Checking database connectivity...
   ✗ DATABASE_URL not set in environment
   Check your .env file
===== Deployment Check Complete =====
If you're still having issues, try running the direct script:
cd /var/www/filmflex && node filmflex-server.js
root@lightnode:~/Film_Flex_Release/scripts/deployment# 