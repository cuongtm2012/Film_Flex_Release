<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    
    <!-- Core Web Vitals & Performance Optimization -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="format-detection" content="telephone=no" />
    
    <!-- Critical Resource Hints - Only preload critical resources -->
    <link rel="dns-prefetch" href="//api.phimgg.com" />
    
    <!-- Optimized title under 580 pixels (about 60 characters) -->
    <title>PhimGG - Free HD Movies & TV Shows Online</title>
    <!-- Optimized description under 1000 pixels (about 155 characters) -->
    <meta name="description" content="Stream thousands of HD movies and TV shows free. Latest releases, classics, and exclusive content. Watch now on PhimGG.com" />
    <meta name="robots" content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1" />
    <meta name="keywords" content="watch movies online, HD movies, latest movies, movie series, cinema online, free movies, PhimGG" />
    <meta name="author" content="PhimGG" />
    
    <!-- Enhanced SEO Meta Tags -->
    <meta name="language" content="en" />
    <meta name="rating" content="General" />
    <meta name="distribution" content="Global" />
    <meta name="revisit-after" content="1 days" />
    <meta name="geo.region" content="US" />
    <meta name="geo.placename" content="United States" />
    <link rel="canonical" href="https://phimgg.com" />
    
    <!-- Enhanced Favicon Support -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="theme-color" content="#3b82f6" />
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="PhimGG - Free HD Movies & TV Shows Online" />
    <meta property="og:description" content="Stream thousands of HD movies and TV shows free. Latest releases, classics, and exclusive content. Watch now on PhimGG.com" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://phimgg.com" />
    <meta property="og:site_name" content="PhimGG" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:image" content="https://phimgg.com/og-image.jpg" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:type" content="image/jpeg" />
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="PhimGG - Free HD Movies & TV Shows Online" />
    <meta name="twitter:description" content="Stream thousands of HD movies and TV shows free. Latest releases, classics, and exclusive content. Watch now on PhimGG.com" />
    <meta name="twitter:site" content="@PhimGG" />
    <meta name="twitter:creator" content="@PhimGG" />
    <meta name="twitter:image" content="https://phimgg.com/twitter-image.jpg" />
    
    <!-- Additional Schema.org Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "PhimGG",
      "alternateName": "PhimGG Movie Streaming",
      "url": "https://phimgg.com",
      "description": "Stream thousands of HD movies and TV shows free. Latest releases, classics, and exclusive content available now.",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://phimgg.com/search?q={search_term_string}",
        "query-input": "required name=search_term_string"
      },
      "publisher": {
        "@type": "Organization",
        "name": "PhimGG",
        "url": "https://phimgg.com",
        "logo": {
          "@type": "ImageObject",
          "url": "https://phimgg.com/logo.png",
          "width": 512,
          "height": 512
        },
        "contactPoint": {
          "@type": "ContactPoint",
          "telephone": "+1-555-PHIMGG",
          "contactType": "customer service",
          "availableLanguage": ["English"]
        }
      },
      "sameAs": [
        "https://twitter.com/PhimGG",
        "https://facebook.com/PhimGG",
        "https://instagram.com/PhimGG"
      ]
    }
    </script>
    
    <!-- Organization Schema -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "PhimGG",
      "url": "https://phimgg.com",
      "logo": "https://phimgg.com/logo.png",
      "description": "Leading free streaming platform for movies and TV shows",
      "foundingDate": "2024",
      "contactPoint": {
        "@type": "ContactPoint",
        "telephone": "+1-555-PHIMGG",
        "contactType": "customer service"
      },
      "address": {
        "@type": "PostalAddress",
        "addressCountry": "US"
      }
    }
    </script>
    
    <!-- Breadcrumb Schema for Homepage -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "name": "Home",
        "item": "https://phimgg.com"
      }]
    }
    </script>
    
    <!-- Performance & Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com https://player.phimapi.com https://*.phim1280.tv https://*.phimapi.com; style-src 'self' 'unsafe-inline' fonts.googleapis.com https://cdn.jsdelivr.net; font-src 'self' fonts.gstatic.com; img-src 'self' data: https: blob:; connect-src 'self' https://api.phimgg.com https: wss: ws: https://*.phim1280.tv https://*.phimapi.com; media-src 'self' https: blob: data: https://*.phim1280.tv https://*.phimapi.com; frame-src 'self' https: http: data: blob: https://player.phimapi.com https://*.phim1280.tv https://*.phimapi.com; child-src 'self' https: http: data: blob: https://player.phimapi.com https://*.phim1280.tv https://*.phimapi.com; object-src 'none';" />
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin" />
    <meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()" />
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Service Worker Registration for PWA with proper update handling -->
    <script>
      // Enhanced Service Worker registration with comprehensive debugging
      const DEBUG_MODE = localStorage.getItem('filmflex-debug') === 'true';
      
      const debugLog = (message, data) => {
        if (DEBUG_MODE) {
          console.log(`ðŸ” SW Debug: ${message}`, data || '');
        }
      };
      
      // Immediately clear problematic caches on page load
      if ('caches' in window) {
        caches.keys().then(cacheNames => {
          const oldCaches = cacheNames.filter(name => 
            name.includes('phimgg-v1') || 
            name.includes('filmflex-v1') || 
            name.includes('filmflex-v2') ||
            !name.includes(Date.now().toString().slice(0, 8)) // Clear caches older than today
          );
          
          if (oldCaches.length > 0) {
            console.log('ðŸ§¹ Clearing old problematic caches:', oldCaches);
            return Promise.all(oldCaches.map(name => caches.delete(name)));
          }
        }).then(() => {
          debugLog('Old caches cleared');
        }).catch(err => {
          console.error('Failed to clear old caches:', err);
        });
      }

      if ('serviceWorker' in navigator) {
        // Enhanced registration with immediate update handling
        navigator.serviceWorker.register('/sw.js', {
          updateViaCache: 'none' // Always check for SW updates
        }).then((registration) => {
          console.log('âœ… SW registered:', registration.scope);
          
          // Force update check immediately
          registration.update();
          
          // Handle updates more aggressively
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            console.log('ðŸ”„ New SW version found, installing...');
            
            if (newWorker) {
              newWorker.addEventListener('statechange', () => {
                console.log('SW state changed to:', newWorker.state);
                
                if (newWorker.state === 'installed') {
                  if (navigator.serviceWorker.controller) {
                    console.log('ðŸš€ New SW installed, forcing activation...');
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                  } else {
                    console.log('âœ… SW installed for first time');
                  }
                }
              });
            }
          });
          
          // Enhanced controller change handling
          navigator.serviceWorker.addEventListener('controllerchange', () => {
            console.log('ðŸ”„ SW controller changed - reloading page...');
            window.location.reload();
          });
          
          // Listen for messages from SW
          navigator.serviceWorker.addEventListener('message', (event) => {
            const { data } = event;
            console.log('ðŸ“¨ Message from SW:', data);
            
            if (data.type === 'SW_ACTIVATED') {
              console.log('âœ… New SW activated:', data.message);
            }
          });
          
        }).catch((error) => {
          console.error('âŒ SW registration failed:', error);
        });
      }
      
      // Enhanced cache management utilities
      window.filmflexCache = {
        // Clear all caches and reload
        clearAll: async () => {
          console.log('ðŸ§¹ Clearing all caches...');
          try {
            // Clear caches
            if ('caches' in window) {
              const cacheNames = await caches.keys();
              console.log('Found caches:', cacheNames);
              await Promise.all(cacheNames.map(name => caches.delete(name)));
            }
            
            // Unregister all service workers
            if ('serviceWorker' in navigator) {
              const registrations = await navigator.serviceWorker.getRegistrations();
              await Promise.all(registrations.map(reg => reg.unregister()));
            }
            
            // Clear storage
            localStorage.clear();
            sessionStorage.clear();
            
            console.log('âœ… All caches and storage cleared');
            window.location.reload();
          } catch (error) {
            console.error('Failed to clear caches:', error);
            window.location.reload();
          }
        },
        
        // Get cache information
        info: async () => {
          if ('caches' in window) {
            const cacheNames = await caches.keys();
            const cacheInfo = await Promise.all(
              cacheNames.map(async (name) => {
                const cache = await caches.open(name);
                const keys = await cache.keys();
                return {
                  name,
                  size: keys.length,
                  urls: keys.map(req => req.url).slice(0, 5) // First 5 URLs
                };
              })
            );
            console.table(cacheInfo);
            return cacheInfo;
          }
        },
        
        // Force SW update
        forceUpdate: async () => {
          if ('serviceWorker' in navigator) {
            const registration = await navigator.serviceWorker.getRegistration();
            if (registration) {
              console.log('ðŸ”„ Forcing SW update...');
              await registration.update();
              console.log('âœ… SW update triggered');
            }
          }
        },
        
        // Enable debug mode
        enableDebug: () => {
          localStorage.setItem('filmflex-debug', 'true');
          console.log('ðŸ”§ Debug mode enabled - reload to see debug logs');
        },
        
        // Disable debug mode
        disableDebug: () => {
          localStorage.removeItem('filmflex-debug');
          console.log('ðŸ”§ Debug mode disabled');
        }
      };
      
      // Auto-detect and fix blank page issues
      setTimeout(() => {
        const rootElement = document.getElementById('root');
        if (rootElement && (!rootElement.innerHTML || rootElement.innerHTML.trim() === '')) {
          console.error('ðŸš¨ BLANK PAGE DETECTED! Root element is empty after 3 seconds');
          console.error('ðŸ”§ Attempting automatic fixes...');
          
          // Show temporary loading message
          rootElement.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: #1a1a2e; color: white; font-family: Arial, sans-serif;">
              <div style="text-align: center; padding: 20px;">
                <div style="font-size: 24px; margin-bottom: 20px;">ðŸ”„ Fixing Loading Issue...</div>
                <div style="margin-bottom: 20px;">Please wait while we resolve the blank page problem.</div>
                <button onclick="filmflexCache.clearAll()" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px;">
                  Clear Cache & Reload
                </button>
                <button onclick="location.reload()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px;">
                  Simple Reload
                </button>
              </div>
            </div>
          `;
          
          // Try automatic cache clear after 2 seconds
          setTimeout(() => {
            console.log('ðŸ”§ Auto-clearing caches due to blank page...');
            filmflexCache.clearAll();
          }, 2000);
        }
      }, 3000);
      
      // Auto-clear cache on version mismatch (enhanced)
      const APP_VERSION = '2025061503'; // Update this with each deployment
      const storedVersion = localStorage.getItem('filmflex-version');
      
      if (storedVersion && storedVersion !== APP_VERSION) {
        console.log(`ðŸ”„ Version mismatch: ${storedVersion} -> ${APP_VERSION}`);
        console.log('ðŸ§¹ Clearing caches for new version...');
        
        if ('caches' in window) {
          caches.keys().then(cacheNames => {
            return Promise.all(cacheNames.map(name => caches.delete(name)));
          }).then(() => {
            localStorage.setItem('filmflex-version', APP_VERSION);
            console.log('âœ… Caches cleared for version update');
          });
        } else {
          localStorage.setItem('filmflex-version', APP_VERSION);
        }
      } else if (!storedVersion) {
        localStorage.setItem('filmflex-version', APP_VERSION);
        console.log('âœ… Version tracking initialized');
      }
      
      // Global error handlers for better debugging
      window.addEventListener('error', (event) => {
        console.error('ðŸš¨ Global Error:', {
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          error: event.error
        });
        
        // If it's a loading error, try cache clear
        if (event.message.includes('Loading') || event.message.includes('import')) {
          console.log('ðŸ”§ Loading error detected, clearing caches in 5 seconds...');
          setTimeout(() => filmflexCache.clearAll(), 5000);
        }
      });
      
      window.addEventListener('unhandledrejection', (event) => {
        console.error('ðŸš¨ Unhandled Promise Rejection:', event.reason);
      });
      
      console.log('ðŸ”§ Enhanced cache management loaded. Use filmflexCache.info() to see cache status');
      console.log('ðŸ”§ Available commands: filmflexCache.clearAll(), filmflexCache.forceUpdate(), filmflexCache.enableDebug()');
    </script>
  </body>
</html>